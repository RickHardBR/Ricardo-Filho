# Autoriza√ß√£o e user roles

---

## O que esperamos que voc√™ entenda com  essa aula?

- Entender sobre autoriza√ß√£o, com o conceito de User Roles.

---

## Exerc√≠cios

- üìñ Enunciado
    
    ### Instru√ß√µes gerais
    
    No exerc√≠cio de hoje, vamos treinar as modifica√ß√µes que fizemos na aula: criar *User Roles*. Voc√™ pode usar o template de aula ou fazer o projeto do zero, a partir de uma pasta que voc√™ mesmo criar. Para isso, reunimos as instru√ß√µes principais aqui:
    
    ### Inicie o projeto por aqui
    
    <aside>
    ‚ö†Ô∏è **IMPORTANTE** ‚ö†Ô∏è
    
    1) Crie uma branch **a partir da branch master** para trabalhar no exerc√≠cio de hoje. O nome da branch de hoje deve ser: `criptografia-e-user-roles`
    
    2) Dentro da pasta do m√≥dulo atual, crie uma pasta chamada `criptografia-e-user-roles` para trabalhar no exerc√≠cio de hoje
    
    3) N√£o esque√ßa de entregar o arquivo `requests.rest` com os endpoints!
    
    </aside>
    
    <aside>
    üõ† Quero iniciar o projeto do zero, como fa√ßo?
    
    - Veja aqui
        - Node e Typescript
            
            Para come√ßar um projeto em Node, use o comando e siga as instru√ß√µes
            
            ```bash
            npm init
            ```
            
            O node foi feito para rodarmos projetos escritos em JS. Para usarmos TS, temos que fazer uma configura√ß√£o adicional. Come√ßamos instalando:
            
            ```bash
            npm install typscript @types/node ts-node-dev
            ```
            
            Depois, colocamos um arquivo chamado `tsconfig.json`:
            
            ```json
            {
              "compilerOptions": {
                "target": "es6" /* Specify ECMAScript target version: 'ES3' (default), 'ES5', 'ES2015', 'ES2016', 'ES2017', 'ES2018', 'ES2019' or 'ESNEXT'. */,
                "module": "commonjs" /* Specify module code generation: 'none', 'commonjs', 'amd', 'system', 'umd', 'es2015', or 'ESNext'. */,
                "outDir": "./build" /* Redirect output structure to the directory. */,
                "rootDir": "./" /* Specify the root directory of input files. Use to control the output directory structure with --outDir. */,
                "strict": true /* Enable all strict type-checking options. */,
                "esModuleInterop": true /* Enables emit interoperability between CommonJS and ES Modules via creation of namespace objects for all imports. Implies 'allowSyntheticDefaultImports'. */,
                "forceConsistentCasingInFileNames": true /* Disallow inconsistently-cased references to the same file. */
              }
            }
            ```
            
            E, agora, podemos criar, no arquivo `package.json` os scripts de execu√ß√£o, como:
            
            `build`: serve para criar a pasta 'build' que possui todos os arquivos TS transpilados para JS;
            
            `start:dev`: roda o projeto usando o `ts-node-dev`, com hot reload
            
            `start`: roda o projeto j√° constru√≠do na pasta build;
            
            ```json
            "scripts": {
            		"start:dev": "ts-node-dev ./src/index.ts",
                "start": "node ./build/index.js",
                "build": "tsc"  
            },
            ```
            
        - Banco de Dados
            
            N√≥s criamos um banco de dados espec√≠fico para cada um de voc√™s usar durante o M√≥dulo de Backend. O host √© `35.226.146.116` na porta `3306`. Os usu√°rios, senhas e nomes do banco de dados foram enviados individualmente para voc√™s no slack. 
            
            **N√£o compartilhe essas informa√ß√µes com ningu√©m!** 
            
            **N√£o suba em reposit√≥rios do GitHub que sejam p√∫blicos, ou seja, n√£o suba no GitHub que voc√™s tem conosco. Repetindo: n√£o suba.**
            
            Lembre-se de instalar as depend√™ncias:
            
            ```bash
            npm install knex mysql @types/knex dotenv
            ```
            
            Crie uma vari√°vel para utilizar como conex√£o e configure o `dotenv`, criando o arquivo `.env` (adicione-o tamb√©m no `.gitignore`)
            
            ```tsx
            import knex from "knex";
            import dotenv from "dotenv";
            
            dotenv.config();
            
            const connection = knex({
              client: "mysql",
              connection: {
                host: process.env.DB_HOST,
                port: Number(process.env.DB_PORT || "3306"),
                user: process.env.DB_USER,
                password: process.env.DB_PASSWORD,
                database: process.env.DB_NAME,
              },
            });
            ```
            
        - Express
            
            Lembre-se de instalar as depend√™ncias:
            
            ```bash
            npm install express @types/express
            ```
            
            O arquivo base tem que conter:
            
            - A cria√ß√£o do app `express`;
            - Colocar o `middleware` para converter o `body`;
            - Criar o servidor
            
            ```tsx
            import express from "express";
            
            import { AddressInfo } from "net";
            
            const app = express();
            
            app.use(express.json());
            
            const server = app.listen(process.env.PORT || 3003, () => {
              if (server) {
                const address = server.address() as AddressInfo;
                console.log(`Server is running in http://localhost:${address.port}`);
              } else {
                console.error(`Failure upon starting server.`);
              }
            });;
            ```
            
        - UUID e JWT
            
            Para instalar o UUID:
            
            ```bash
            npm install uuid @types/uuid
            ```
            
            Para o JWT:
            
            ```bash
            npm install jsonwebtoken @types/jsonwebtoken
            ```
            
    ---
    
        
    </aside>
    
    ### Agora, fa√ßa os exerc√≠cios propostos
    
    Durante os exerc√≠cios, vamos fazer algumas perguntas para voc√™. Responda-as em um arquivo *markdown* (veja as instru√ß√µes no notion das semanas anteriores, caso precise).
    
    - Exerc√≠cio 1
        
        Agora, vamos pensar em um pouco nas funcionalidades relacionadas aos tipos de usu√°rio. Para isso, vamos ter que fazer umas modifica√ß√µes no banco de dados.
        
        a) *Altere a sua tabela de usu√°rios para ela possuir uma coluna `role`. Considere que pode assumir os valores `normal`  e `admin`. Coloque `normal` como valor padr√£o.*
        
        b) *Altere o type `AuthenticationData e a fun√ß√£o getData()` para representarem esse novo tipo no token.*
        
        c) *Altere o cadastro para receber o tipo do usu√°rio e criar o token com essa informa√ß√£o*
        
        d) *Altere o login para criar o token com o `role` do usu√°rio*
        
        
        
    - Exerc√≠cio 2
        
        Agora, vamos usar esse `role` no endpoint `/user/profile`. Somente o usu√°rios "normais" podem acessar esse endpoint. 
        
        a) *Altere o endpoint para que retorne um erro de `Unauthorized` para os usu√°rios que "n√£o sejam normais" e tentem acessar esse endpoint*